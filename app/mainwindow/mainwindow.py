import re
import sys
from PySide6.QtCore import Qt, QFile, Slot
from PySide6.QtGui import QBrush, QColor, QFont, QIcon
from PySide6.QtWidgets import QApplication, QMainWindow, QGridLayout, QWidget, QColorDialog, QListWidgetItem, \
    QVBoxLayout, QListWidget, QSizePolicy, QFileDialog

from app.common import ansi16_to_hex, strip_ansi_codes, ansi256_to_hex
from app.widgets.addfontcard import AddFontCard
from app.widgets.colordisplaywidget import ColorDisplayWidget
from app.mainwindow.ui_mainwindow import Ui_MainWindow
from app.widgets.fontcard import FontCard
from app.widgets.homewidget import  MinimalAIHome
from app.widgets.iconbrowser import IconBrowserWidget
from app.widgets.loggingwindow import QLogWidget
from app.widgets.settingsitemwidget import SettingItemWidget
from app.widgets.titlebar import CustomTitleBar
from qtpop import QtPop
from qtpop.configuration.models import SettingItem
from qtpop.qtpoplogger import debug_log


# generated by pyside6-uic

class MainWindow(QMainWindow):
    def __init__(self, qt_pop: QtPop):
        super().__init__()
        self.titlebar = None
        self.icon_widget = None
        self.home = None
        self.log_widget = None
        self.qt_pop = qt_pop
        self.ui = Ui_MainWindow()
        self.ui.setupUi(self)
        self.setWindowFlags(Qt.FramelessWindowHint | Qt.Window)
        self.load_fonts()
        self.load_ui()

        self.qt_pop.log.info("MainWindow initialized successfully.")
        self.qt_pop.data.broadcast_message("main_window_opened", True)

    def load_fonts(self):
        self.qt_pop.font.load_font("resources/fonts/RobotoCondensed-VariableFont_wght.ttf", "h1", 18)
        self.qt_pop.font.load_font("resources/fonts/RobotoCondensed-VariableFont_wght.ttf", "h2", 14)
        self.qt_pop.font.load_font("resources/fonts/Roboto-VariableFont_wdth,wght.ttf", "p", 11)
        self.qt_pop.font.load_font("resources/fonts/RobotoCondensed-VariableFont_wght.ttf", "pc", 10)
        self.qt_pop.font.load_font("resources/fonts/Inconsolata-VariableFont_wdth,wght.ttf", "log", 11)
        self.qt_pop.font.load_font("resources/fonts/JollyLodger-Regular.ttf", "style", 12)

    def load_ui(self):
        self.setup_logging()

        self.setup_palette()
        self.setup_settings()
        self.setup_qss()
        self.setup_fonts()
        self.setup_home()
        self.setup_icons()

        if self.titlebar is not None:
            self.ui.centralwidget.layout().removeWidget(self.titlebar)
        icon = QIcon(self.qt_pop.icon.get_pixmap('action join left', self.qt_pop.style.get_colour('accent')))  # replace with your logo path
        self.titlebar = CustomTitleBar(self.qt_pop, self, icon, self.qt_pop.config.get_value('name'))
        self.ui.centralwidget.layout().insertWidget(0, self.titlebar)

        self.apply_style()
        self.set_application_font("pc")

        self.ui.saveBtn.clicked.disconnect() if hasattr(self.ui.saveBtn, "clicked") else None
        self.ui.saveBtn.clicked.connect(self.save_settings)


    @debug_log
    def setup_palette(self):
        def load_palette():
            grid = QGridLayout()
            grid.setSpacing(5)
            grid.setContentsMargins(5, 5, 5, 5)
            columns = 5

            for i, (item, hex_val) in enumerate(self.qt_pop.style.colour_map().items()):
                row = i // columns
                col = i % columns
                grid.addWidget(ColorDisplayWidget(hex_val, item), row, col)

            old_layout = self.ui.p_frame.layout()
            if old_layout is not None:
                QWidget().setLayout(old_layout)

            self.ui.p_frame.setLayout(grid)
        load_palette()

    @debug_log
    def setup_settings(self):
        toolbox = self.ui.settingsTB
        while toolbox.count() > 0:
            toolbox.removeItem(0)  # clear existing pages

        # --- Group user settings by 'group' ---
        grouped_settings = {}
        for key, item in self.qt_pop.config.data.configuration.user.items():
            grouped_settings.setdefault(item.group, []).append(item)

        # --- Create a QListWidget per group ---
        for group_name, items in grouped_settings.items():
            list_widget = QListWidget()
            list_widget.setSizePolicy(QSizePolicy.Policy.Expanding, QSizePolicy.Policy.Expanding)

            for item in items:
                self.qt_pop.log.info(f"Loading setting {item.name}, value: {item.value}")
                custom_widget = SettingItemWidget(item)
                list_item = QListWidgetItem(list_widget)
                hint = custom_widget.sizeHint()
                hint.setHeight(hint.height() + 10)
                list_item.setSizeHint(hint)
                list_widget.addItem(list_item)
                list_widget.setItemWidget(list_item, custom_widget)

            toolbox.addItem(list_widget, group_name)

        # --- Add static settings page ---
        static_widget = QListWidget()
        for key, value in self.qt_pop.config.data.configuration.static.items():
            self.qt_pop.log.info(f"Loading static setting {key}, value: {value}")
            item = SettingItem(key, key, value, [], "Application static setting", "text", "user", "Static", "")
            custom_widget = SettingItemWidget(item)
            list_item = QListWidgetItem(static_widget)
            hint = custom_widget.sizeHint()
            hint.setHeight(hint.height() + 10)
            list_item.setSizeHint(hint)
            static_widget.addItem(list_item)
            static_widget.setItemWidget(list_item, custom_widget)

        toolbox.addItem(static_widget, "Static Settings")

        icon_color = self.qt_pop.style.get_colour('accent')
        for i in range(toolbox.count()):
            toolbox.setItemIcon(i, self.qt_pop.icon.get_pixmap("app settings", icon_color))

        # --- Connect save button ---

    def apply_style(self):
        accent = self.qt_pop.config.get_value('accent')
        support = self.qt_pop.config.get_value('support')
        neutral = self.qt_pop.config.get_value('neutral')
        theme = self.qt_pop.config.get_value('theme')
        self.qt_pop.style.initialise(accent.value, support.value, neutral.value, theme.value)

        qss = self.ui.cqss.toPlainText()
        translated_qss = self.qt_pop.qss.process(qss)
        self.setStyleSheet(translated_qss)
        self.setPalette(self.qt_pop.style.get_palette())


    @Slot()
    @debug_log
    def save_settings(self):
        toolbox = self.ui.settingsTB

        for i in range(toolbox.count()):
            page_widget = toolbox.widget(i)
            group_name = toolbox.itemText(i)

            # Iterate through each QListWidgetItem in the page
            for row in range(page_widget.count()):
                list_item = page_widget.item(row)
                custom_widget = page_widget.itemWidget(list_item)
                if not custom_widget:
                    continue

                # Assuming SettingItemWidget has `item` and `get_value()` methods
                setting_item = custom_widget.item
                new_value = setting_item.value # e.g., from QLineEdit, ComboBox, etc.
                self.qt_pop.config.set_value(setting_item.shortname, new_value)
                setting_item.value = new_value  # update local copy

        # Optionally persist configuration to disk
        if hasattr(self.qt_pop.config, "save"):
            self.qt_pop.config.save()

        self.qt_pop.log.info("All settings saved successfully.")
        self.qt_pop.log.info("Applying settings...")
        self.apply_style()
        self.load_ui()
        self.qt_pop.log.info("All settings applied successfully.")

    @debug_log
    def setup_logging(self):
        def on_log(timestamp: str, message: str, level: str = "INFO", color: str = ""):
            """Handle log records (for future use)."""
            self.ui.statusbar.setStyleSheet("QStatusBar{color: " + color + "; }")
            self.ui.statusbar.showMessage(message, 5000)
        # inside your setup_logging or after creating the widget instance:
        if self.log_widget is None:
            self.log_widget = QLogWidget(self.qt_pop)
            self.log_widget.table.setFont(self.qt_pop.font.get_font('log'))
            # self.log_widget.setFont(self.qt_pop.font.get_font('log'))
            self.ui.log.layout().addWidget(self.log_widget)
            self.qt_pop.log.signal.connect(self.log_widget.append_log)
            self.qt_pop.log.signal.connect(on_log)

        self.qt_pop.log.info("Running log test messages...")
        self.qt_pop.log.warning("This is a warning message.")
        self.qt_pop.log.error("This is an error message.")
        self.qt_pop.log.info("This is an info message.")
        self.qt_pop.log.debug("This is a debug message.")
        self.qt_pop.log.critical("This is a critical message.")

    def setup_qss(self):
        """Setup QSS editor with load and apply buttons."""
        qss_path = self.qt_pop.config.get_value('qss_path')
        file = QFile(qss_path.value)
        default_qss = ""

        if file.open(QFile.ReadOnly | QFile.Text):
            default_qss = file.readAll().data().decode("utf-8")
            file.close()

        # Set initial QSS in code editor
        self.ui.cqss.setText(default_qss)

        # Process and apply default QSS
        translated_qss = self.qt_pop.qss.process(default_qss)
        self.ui.tqss.setText(translated_qss)
        self.qt_pop.qss.set_style(translated_qss)
        self.ui.cqss.setFont(self.qt_pop.font.get_font('log', 10))
        self.ui.tqss.setFont(self.qt_pop.font.get_font('log', 10))

        # ---- Button Connections ----
        def on_apply_clicked():
            """Apply QSS from cqss."""
            raw_qss = self.ui.cqss.toPlainText()
            translated = self.qt_pop.qss.process(raw_qss)
            self.ui.tqss.setText(translated)
            self.setStyleSheet(translated)
            self.qt_pop.log.info("Applied translated QSS.")

        def on_load_clicked():
            """Load QSS file into cqss."""
            file_path, _ = QFileDialog.getOpenFileName(
                self,
                "Open QSS File",
                "",
                "QSS Files (*.qss);;All Files (*), All Files (*)"
            )
            if not file_path:
                return
            with open(file_path, "r", encoding="utf-8") as f:
                qss_content = f.read()
            self.ui.cqss.setText(qss_content)
            self.qt_pop.log.info(f"Loaded QSS file: {file_path}")

        # Connect buttons
        self.ui.applybtn.clicked.connect(on_apply_clicked)
        self.ui.loadbtn.clicked.connect(on_load_clicked)

    def resizeEvent(self, event, /):
        super().resizeEvent(event)
        # self.ui.statusbar.showMessage(f"{self.width()} x {self.height()}")

    def setup_fonts(self):
        lw = self.ui.fontLW
        lw.clear()
        lw.setSpacing(6)
        self.load_add_font(lw)
        self.load_font_cards(lw)

    def load_add_font(self, lw):
        add_card = AddFontCard(self.add_font_callback)
        add_item = QListWidgetItem(lw)
        hint = add_card.sizeHint()
        hint.setHeight(hint.height() + 20)
        add_item.setSizeHint(hint)
        lw.addItem(add_item)
        lw.setItemWidget(add_item, add_card)

    def load_font_cards(self, lw):
        font_map = self.qt_pop.font.get_font_map()
        for tag, info in font_map.items():
            card = FontCard(info['family'], tag, info['size'], self.set_application_font)
            item = QListWidgetItem(lw)
            hint = card.sizeHint()
            hint.setHeight(hint.height() + 10)
            item.setSizeHint(hint)
            lw.addItem(item)
            lw.setItemWidget(item, card)


    def add_font_callback(self, font_path, tag, size):
        self.qt_pop.font.load_font(font_path, tag, size)
        lw = self.ui.fontLW
        lw.clear()
        lw.setSpacing(6)
        self.load_add_font(lw)
        self.load_font_cards(lw)

    def set_application_font(self, tag: str, size = None):
        """Sets the application-wide font."""
        font = self.qt_pop.font.get_font(tag)
        if size is not None:
            font.setPointSize(size)
        app = QApplication.instance()
        app.setFont(font)
        self.apply_style()

    def setup_home(self):
        if self.home is None:
            self.home = MinimalAIHome(
                qt_pop=self.qt_pop,
                app_name= self.qt_pop.config.get_value('name'),
                tagline="Vivid tools. Joyful creation.",
                version=self.qt_pop.config.get_value('version'),
                description="A cutting-edge desktop application designed for creative professionals, "
                            "offering a suite of powerful tools to bring your ideas to life with ease and precision.",
                svg_data=None  # pass your SVG string here if you have one
            )

            self.ui.home.layout().addWidget(self.home)

    def setup_icons(self):
        if self.icon_widget is None:
            self.icon_widget = IconBrowserWidget(qt_pop=self.qt_pop, images_path=self.qt_pop.config.get_value('icon_path'), parent=self)
            self.ui.icons.layout().addWidget(self.icon_widget)